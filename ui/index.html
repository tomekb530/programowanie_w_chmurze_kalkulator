<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator</title>
    <!-- Ładowanie Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Konfiguracja czcionki Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Jasne tło */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        /* Customowe style dla przycisków */
        .calc-button {
            @apply p-4 rounded-xl text-2xl font-semibold transition duration-150 ease-in-out shadow-lg transform hover:scale-[1.03];
            user-select: none;
            cursor: pointer;
        }
        /* Definicja animacji 'pulse' (dla niespodzianki) */
        @keyframes pulse-once {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        .animate-pulse-once {
            animation: pulse-once 0.5s ease-in-out infinite alternate;
        }
    </style>
</head>
<body id="body">

    <div class="w-full max-w-sm bg-white p-6 rounded-3xl shadow-2xl transition-colors duration-500" id="calculator-card">
        <h1 class="text-3xl font-extrabold text-center text-gray-800 mb-6 transition-colors duration-500" id="calculator-title">Kalkulator PRO</h1>

        <!-- Wyświetlacz -->
        <div id="display" class="bg-gray-800 text-white p-6 mb-6 rounded-2xl text-right overflow-hidden shadow-inner transition-colors duration-500">
            <!-- Górny wyświetlacz teraz pokazuje trwającą operację LUB pełne wyrażenie po znaku '=' -->
            <div id="previous-operation" class="text-sm text-gray-400 h-6 transition-colors duration-500"></div>
            <div id="current-input" class="text-5xl font-bold truncate transition-colors duration-500">0</div>
        </div>

        <!-- Panel Przycisków (Grid 4x6) -->
        <div class="grid grid-cols-4 gap-3">

            <!-- Funkcje Pamięci -->
            <button onclick="calculator.memoryClear()" class="calc-button bg-blue-100 text-blue-700 hover:bg-blue-200">MC</button>
            <button onclick="calculator.memoryRecall()" class="calc-button bg-blue-100 text-blue-700 hover:bg-blue-200">MR</button>
            <button onclick="calculator.memoryAdd()" class="calc-button bg-blue-100 text-blue-700 hover:bg-blue-200">M+</button>
            <button onclick="calculator.memorySubtract()" class="calc-button bg-blue-100 text-blue-700 hover:bg-blue-200">M-</button>

            <!-- Główne Operacje -->
            <button onclick="calculator.clear()" class="calc-button bg-red-500 text-white hover:bg-red-600">AC</button>
            <button onclick="calculator.setOperation('/')" class="calc-button bg-gray-200 text-gray-700 hover:bg-gray-300">÷</button>
            <button onclick="calculator.setOperation('*')" class="calc-button bg-gray-200 text-gray-700 hover:bg-gray-300">×</button>
            <button onclick="calculator.setOperation('-')" class="calc-button bg-gray-200 text-gray-700 hover:bg-gray-300">-</button>

            <!-- Cyfry i kropka -->
            <button onclick="calculator.appendDigit('7')" class="calc-button bg-gray-100 text-gray-800 hover:bg-gray-200">7</button>
            <button onclick="calculator.appendDigit('8')" class="calc-button bg-gray-100 text-gray-800 hover:bg-gray-200">8</button>
            <button onclick="calculator.appendDigit('9')" class="calc-button bg-gray-100 text-gray-800 hover:bg-gray-200">9</button>
            <button onclick="calculator.setOperation('+')" class="calc-button bg-orange-500 text-white hover:bg-orange-600 row-span-2">+</button>

            <button onclick="calculator.appendDigit('4')" class="calc-button bg-gray-100 text-gray-800 hover:bg-gray-200">4</button>
            <button onclick="calculator.appendDigit('5')" class="calc-button bg-gray-100 text-gray-800 hover:bg-gray-200">5</button>
            <button onclick="calculator.appendDigit('6')" class="calc-button bg-gray-100 text-gray-800 hover:bg-gray-200">6</button>

            <button onclick="calculator.appendDigit('1')" class="calc-button bg-gray-100 text-gray-800 hover:bg-gray-200">1</button>
            <button onclick="calculator.appendDigit('2')" class="calc-button bg-gray-100 text-gray-800 hover:bg-gray-200">2</button>
            <button onclick="calculator.appendDigit('3')" class="calc-button bg-gray-100 text-gray-800 hover:bg-gray-200">3</button>

            <button onclick="calculator.calculate()" class="calc-button bg-green-500 text-white hover:bg-green-600 row-span-2">=</button>

            <button onclick="calculator.appendDigit('0')" class="calc-button col-span-2 bg-gray-100 text-gray-800 hover:bg-gray-200">0</button>
            <button onclick="calculator.appendDigit('.')" class="calc-button bg-gray-100 text-gray-800 hover:bg-gray-200">.</button>

        </div>
    </div>

    <script>
        // Skrypt JavaScript dla logiki kalkulatora
        const displayCurrent = document.getElementById('current-input');
        const displayPrevious = document.getElementById('previous-operation');
        const calculatorCard = document.getElementById('calculator-card');
        const calculatorTitle = document.getElementById('calculator-title');

        // Obiekt przechowujący stan kalkulatora
        const calculator = {
            currentInput: '0',
            previousInput: null,
            operation: null,
            memory: 0,
            waitingForSecondOperand: false,
            memoryIndicator: '',
            lastExpression: null // Nowa właściwość: przechowuje pełne wyrażenie po znaku '='
        };

        // --- FUNKCJE ZAPISU I ODCZYTU STANU Z URL ---

        /**
         * Zwraca czysty obiekt stanu kalkulatora, który można bezpiecznie klonować.
         * Wymagane, ponieważ history.pushState nie może klonować funkcji (metod obiektu).
         */
        function getCalculatorDataState() {
            return {
                currentInput: calculator.currentInput,
                previousInput: calculator.previousInput,
                operation: calculator.operation,
                memory: calculator.memory,
                waitingForSecondOperand: calculator.waitingForSecondOperand,
                memoryIndicator: calculator.memoryIndicator,
                lastExpression: calculator.lastExpression
            };
        }

        // Funkcja do aktualizacji adresu URL na podstawie stanu kalkulatora (dla trwających operacji)
        function updateUrlState() {
            const params = new URLSearchParams();

            // Zapisujemy poprzednią wartość, operację i bieżącą wartość do URL
            if (calculator.previousInput !== null) {
                params.set('prev', calculator.previousInput);
                
                // Zapisz operację, tylko jeśli jest ustawiona
                if (calculator.operation !== null) {
                    params.set('op', calculator.operation);
                }
            }
            
            // Zapisz bieżącą wartość, o ile nie jest to stan początkowy '0' bez operacji
            if (calculator.currentInput !== '0' || calculator.previousInput !== null) {
                 params.set('current', calculator.currentInput);
            }
            
            // Konstrukcja nowego URL
            const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
            
            // Użycie history.pushState, aby zmienić URL bez przeładowania strony
            // Używamy funkcji getCalculatorDataState() aby uniknąć DataCloneError
            history.pushState(getCalculatorDataState(), 'Kalkulator', newUrl);
        }

        // Nowa funkcja do zapisu pełnego obliczenia w URL po naciśnięciu '='
        function updateUrlStateForCalculationResult(expression, result) {
            const params = new URLSearchParams();
            params.set('exp', expression); // Pełne wyrażenie
            params.set('res', result);    // Wynik
            
            const newUrl = window.location.pathname + '?' + params.toString();
            // Używamy funkcji getCalculatorDataState() aby uniknąć DataCloneError
            history.pushState(getCalculatorDataState(), 'Kalkulator', newUrl);
        }


        // Funkcja do wczytywania stanu z parametrów URL
        function loadStateFromUrl() {
            const params = new URLSearchParams(window.location.search);
            
            const exp = params.get('exp');
            const res = params.get('res');

            // 1. Sprawdzenie, czy URL zawiera zakończone obliczenie (exp i res)
            if (exp && res) {
                calculator.currentInput = res;
                calculator.lastExpression = exp;
                calculator.previousInput = null; // Wewnętrznie resetujemy stan
                calculator.operation = null;
                calculator.waitingForSecondOperand = true; 
            } 
            // 2. Wczytanie trwającego obliczenia lub pojedynczej liczby (stara logika)
            else {
                const prev = params.get('prev');
                const current = params.get('current');
                const op = params.get('op');
                
                calculator.lastExpression = null; // Czyścimy pełne wyrażenie
                
                if (current) {
                    calculator.currentInput = current;
                } else {
                    calculator.currentInput = '0'; 
                }

                if (prev) {
                    calculator.previousInput = prev;
                } else {
                     calculator.previousInput = null;
                }

                if (op) {
                    calculator.operation = op;
                    calculator.waitingForSecondOperand = true; 
                } else {
                    calculator.operation = null;
                    calculator.waitingForSecondOperand = false;
                }
            }

            // Pamięć nie jest zapisywana w URL, więc zostaje bez zmian.
            updateDisplay();
        }

        // --- GŁÓWNA LOGIKA KALKULATORA ---

        // Aktualizacja wyświetlacza na podstawie stanu
        function updateDisplay() {
            // Wyświetla bieżący wynik lub wprowadzoną liczbę
            displayCurrent.textContent = calculator.currentInput;

            let previousText = '';
            
            if (calculator.lastExpression !== null) {
                 // Jeśli jest wynik obliczenia (po '=') - wyświetl całe wyrażenie
                 previousText = calculator.lastExpression;
            }
            else if (calculator.previousInput !== null && calculator.operation !== null) {
                // W przeciwnym razie wyświetl trwającą operację
                // Konwersja symboli operacji na symbole Unicode
                const opSymbol = {
                    '+': '+',
                    '-': '-',
                    '*': '×', // Symbol Unicode
                    '/': '÷'  // Symbol Unicode
                }[calculator.operation] || calculator.operation;

                previousText = `${calculator.previousInput} ${opSymbol}`;
            }

            // Dodaje wskaźnik pamięci, jeśli jest używana
            if (calculator.memoryIndicator) {
                 previousText = `[M] ${previousText}`;
            }

            displayPrevious.textContent = previousText;
        }

        // Funkcja do wprowadzania cyfr i kropki
        calculator.appendDigit = function(digit) {
            if (calculator.currentInput.length >= 18) return; // Ograniczenie długości
            
            // Czyść ostatnie wyrażenie, jeśli użytkownik zaczyna pisać
            calculator.lastExpression = null; 

            if (calculator.waitingForSecondOperand === true) {
                // Jeśli czekamy na drugi operand, czyścimy wyświetlacz
                calculator.currentInput = digit;
                calculator.waitingForSecondOperand = false;
            } else if (digit === '.') {
                // Dodawanie kropki dziesiętnej
                if (!calculator.currentInput.includes('.')) {
                    calculator.currentInput += '.';
                }
            } else {
                // Dodawanie cyfry
                if (calculator.currentInput === '0' || calculator.currentInput === '-0') {
                    calculator.currentInput = digit;
                } else {
                    calculator.currentInput += digit;
                }
            }
            updateDisplay();
            updateUrlState(); // Zapisz nowy stan do URL
        };

        // Funkcja do ustawiania operacji
        calculator.setOperation = function(nextOperation) {
            // Czyść ostatnie wyrażenie, jeśli użytkownik zaczyna nową operację
            calculator.lastExpression = null;

            const inputValue = parseFloat(calculator.currentInput);

            // Jeśli nie ma poprzedniego wejścia, ustaw bieżące jako poprzednie
            if (calculator.previousInput === null) {
                calculator.previousInput = calculator.currentInput;
            }
            // Jeśli już jest wybrana operacja i nie czekamy na nowy operand, wykonaj obliczenie
            else if (calculator.operation && !calculator.waitingForSecondOperand) {
                this.calculate();
                // Po obliczeniu poprzedni wynik staje się nowym previousInput
                calculator.previousInput = calculator.currentInput;
            }

            // Ustaw nową operację
            calculator.operation = nextOperation;
            calculator.waitingForSecondOperand = true;
            updateDisplay();
            updateUrlState(); // Zapisz nowy stan do URL
        };

        // Funkcja uruchamiająca niespodziankę (Easter Egg)
        calculator.triggerEasterEgg = function(message, cardClass, titleClass, displayClass, duration = 3000) {
            
            // Zdefiniuj klasy początkowe, które muszą być usunięte
            // Użycie spacji w tych ciągach jest w porządku,
            // dopóki używamy metody split(' ') i operatora rozpraszania do ich usunięcia/dodania.
            const originalTitleClasses = 'text-gray-800';
            const originalCardClasses = 'bg-white';
            const originalDisplayClasses = 'bg-gray-800 text-white'; // Ten ciąg powodował błąd

            const displayElement = document.getElementById('display');
            const previousOperationElement = document.getElementById('previous-operation');

            // --- POPRAWKA BŁĘDU: Użycie split(' ') i operatora rozpraszania (...) dla usunięcia klas ---

            // Usuń klasy używane do animacji, aby reset był płynny
            calculatorCard.classList.remove('bg-purple-600', 'bg-red-900', 'bg-orange-400', 'bg-indigo-500', 'animate-pulse-once');
            calculatorTitle.classList.remove('text-yellow-300', 'text-white', 'text-gray-800');
            displayElement.classList.remove('bg-black', 'text-yellow-400', 'bg-red-900', 'text-red-500', 'bg-orange-900', 'text-white', 'bg-indigo-900', 'text-green-300');
            previousOperationElement.classList.remove('text-white');

            // USUNIĘCIE KLAS POCZĄTKOWYCH PRZY POMOCY split(' ') i ...
            // Używamy .split(' ') do podziału ciągu na pojedyncze klasy
            calculatorCard.classList.remove(...originalCardClasses.split(' '));
            calculatorTitle.classList.remove(...originalTitleClasses.split(' '));
            displayElement.classList.remove(...originalDisplayClasses.split(' ')); 


            // --- ZMIANA WIZUALNA: DODANIE KLAS EASTER EGG ---
            
            // Dodanie nowych klas (również bezpieczne dzięki .split(' ') i ...)
            calculatorCard.classList.add(...cardClass.split(' '));
            calculatorTitle.classList.add(...titleClass.split(' '));
            displayElement.classList.add(...displayClass.split(' '));
            
            previousOperationElement.classList.add('text-white'); // Utrzymaj białe tło dla górnego tekstu

            const originalDisplayContent = displayCurrent.textContent;
            displayCurrent.textContent = message;

            // Resetowanie wizualne
            setTimeout(() => {
                // Resetowanie klas do stanu początkowego
                calculatorCard.className = 'w-full max-w-sm bg-white p-6 rounded-3xl shadow-2xl transition-colors duration-500';
                calculatorTitle.className = 'text-3xl font-extrabold text-center text-gray-800 mb-6 transition-colors duration-500';
                displayElement.className = 'bg-gray-800 text-white p-6 mb-6 rounded-2xl text-right overflow-hidden shadow-inner transition-colors duration-500';
                
                // Upewnij się, że tekst poprzedniej operacji wraca do szarego
                document.getElementById('previous-operation').classList.remove('text-white');
                document.getElementById('previous-operation').classList.add('text-gray-400');
                
                // Resetowanie tekstu wyświetlacza
                displayCurrent.textContent = originalDisplayContent;
                updateDisplay(); 
            }, duration);
        };

        // Główna funkcja obliczeniowa
        calculator.calculate = function() {
            const prev = parseFloat(calculator.previousInput);
            const current = parseFloat(calculator.currentInput);

            if (isNaN(prev) || isNaN(current) || calculator.operation === null) {
                return; // Nie ma nic do obliczenia
            }

            let result = 0;
            // Zapisanie operandów i operacji przed ewentualnym błędem i zresetowaniem
            const operandA = calculator.previousInput;
            const operator = calculator.operation;
            const operandB = calculator.currentInput;

            try {
                switch (calculator.operation) {
                    case '+':
                        result = prev + current;
                        break;
                    case '-':
                        result = prev - current;
                        break;
                    case '*':
                        result = prev * current;
                        break;
                    case '/':
                        if (current === 0) {
                            calculator.currentInput = 'Błąd: Dzielenie przez 0';
                            calculator.previousInput = null;
                            calculator.operation = null;
                            calculator.lastExpression = null; // Usuń wyrażenie w przypadku błędu
                            updateDisplay();
                            updateUrlState(); // Zapisz błąd do URL (tylko current)
                            return;
                        }
                        result = prev / current;
                        break;
                    default:
                        return;
                }

                // --- ZMIANA LOGIKI: SPRAWDZANIE EASTER EGGÓW NA CZYSTYM WYNIKU (result) ---
                
                let finalResult;
                let finalResultString;

                // !!! SPRAWDZENIE NIESPODZIANEK (EASTER EGGS) !!!
                // Sprawdzamy czysty wynik operacji result
                if (result === 42) {
                    calculator.triggerEasterEgg(
                        "ŻYCIE, WSZECHŚWIAT I CAŁA RESZTA!", 
                        'bg-purple-600 animate-pulse-once', 
                        'text-yellow-300', 
                        'bg-black text-yellow-400',
                        3000
                    );
                } else if (result === 3.14) {
                     calculator.triggerEasterEgg(
                        "DZIEŃ LICZBY PI!", 
                        'bg-orange-400', 
                        'text-gray-800', 
                        'bg-orange-900 text-white',
                        2500
                    );
                } else if (result === 666) { // Teraz to działa poprawnie!
                    calculator.triggerEasterEgg(
                        "NUMER BESTII!", 
                        'bg-red-900 shadow-red-900/50 shadow-2xl', 
                        'text-white', 
                        'bg-black text-red-500',
                        2500
                    );
                } else if (result === 12345) {
                     calculator.triggerEasterEgg(
                        "SEKWENCJA ZABLOKOWANA!", 
                        'bg-indigo-500', 
                        'text-white', 
                        'bg-indigo-900 text-green-300',
                        2500
                    );
                }
                
                // Ograniczenie liczby cyfr po przecinku (do 10) i konwersja na string do wyświetlenia
                finalResult = parseFloat(result.toFixed(10));
                finalResultString = finalResult.toString();
                calculator.currentInput = finalResultString;


                // Tworzenie pełnego wyrażenia do wyświetlenia w górnym polu
                const opSymbol = { '+': '+', '-': '-', '*': '×', '/': '÷' }[operator] || operator;
                const fullExpression = `${operandA} ${opSymbol} ${operandB} =`;
                calculator.lastExpression = fullExpression; // Zapis pełnego wyrażenia


                // Resetowanie stanu dla następnej operacji
                calculator.operation = null;
                calculator.previousInput = null;
                calculator.waitingForSecondOperand = true; // Pozwala na rozpoczęcie nowego obliczenia
                
                updateDisplay();
                updateUrlStateForCalculationResult(fullExpression, finalResultString); // Zapisz pełne obliczenie do URL

            } catch (error) {
                // W przypadku błędu (np. błąd w eval, chociaż tutaj go nie używamy, ale zostawiamy)
                console.error("Błąd podczas obliczeń:", error);
                calculator.currentInput = 'Błąd obliczeń';
                calculator.lastExpression = null;
                calculator.operation = null;
                calculator.previousInput = null;
                calculator.waitingForSecondOperand = true;
                updateDisplay();
                updateUrlState(); 
            }
        };

        // Funkcja czyszcząca (All Clear)
        calculator.clear = function() {
            calculator.currentInput = '0';
            calculator.previousInput = null;
            calculator.operation = null;
            calculator.waitingForSecondOperand = false;
            calculator.lastExpression = null; // Czyścimy wyrażenie po naciśnięciu AC
            updateDisplay();
            updateUrlState(); // Zapisz pusty stan do URL
        };

        // --- Funkcje Pamięci ---
        // Memory Clear (MC) - Czyści pamięć
        calculator.memoryClear = function() {
            calculator.memory = 0;
            calculator.memoryIndicator = '';
            updateDisplay();
        };

        // Memory Recall (MR) - Wywołuje wartość z pamięci
        calculator.memoryRecall = function() {
            calculator.currentInput = calculator.memory.toString();
            calculator.waitingForSecondOperand = true;
            calculator.memoryIndicator = '[M]';
            calculator.lastExpression = null; // Czyścimy wyrażenie
            updateDisplay();
            updateUrlState(); // Zapisz nową currentInput do URL
        };

        // Memory Add (M+) - Dodaje bieżący wynik do pamięci
        calculator.memoryAdd = function() {
            const currentValue = parseFloat(calculator.currentInput);
            if (!isNaN(currentValue)) {
                calculator.memory += currentValue;
                calculator.memoryIndicator = '[M]';
            }
            updateDisplay();
        };

        // Memory Subtract (M-) - Odejmuje bieżący wynik od pamięci
        calculator.memorySubtract = function() {
            const currentValue = parseFloat(calculator.currentInput);
            if (!isNaN(currentValue)) {
                calculator.memory -= currentValue;
                calculator.memoryIndicator = '[M]';
            }
            updateDisplay();
        };

        // Inicjalizacja wyświetlacza przy starcie
        window.onload = function() {
            // 1. Wczytaj stan z URL (lub ustaw domyślny)
            loadStateFromUrl();

            // 2. Nasłuchuj zdarzeń popstate (przycisk Wstecz/Dalej w przeglądarce)
            window.addEventListener('popstate', (e) => {
                loadStateFromUrl();
            });

            // Umożliwienie wprowadzania z klawiatury (bez zmian)
            document.addEventListener('keydown', (e) => {
                // Zapobiegaj domyślnej akcji przeglądarki dla '=' (np. uruchomienie linku)
                if (e.key === 'Enter' || e.key === '=') {
                    e.preventDefault();
                    calculator.calculate();
                    return;
                }
                
                // Upewnienie się, że klawisz nie jest klawiszem funkcyjnym
                if (e.key.length === 1 && /[0-9]/.test(e.key)) {
                    calculator.appendDigit(e.key);
                } else if (e.key === '.') {
                    calculator.appendDigit('.');
                } else if (e.key === '+' || e.key === '-' || e.key === '*' || e.key === '/') {
                    calculator.setOperation(e.key);
                } else if (e.key === 'Escape' || e.key === 'c' || e.key === 'C') {
                    calculator.clear();
                }
            });
        };
    </script>

</body>
</html>
